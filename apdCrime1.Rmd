---
title: "APD Crime Data"
author: "Rob Gordon"
date: '`r format(Sys.time(), "%b-%d-%Y")`'
output: 
  html_document: 
    toc: yes
---

Last Updated: `r Sys.Date()`

## Introduction

Let's do stuff with the Atlanta Crime Data. We'll closely follow the [codeforatlanta/apd-crime-data github](https://github.com/codeforatlanta/apd-crime-data).

Namley, we'll following these steps listed in the README:

- Get data
    - Download raw data file & unzip the csv contents into your working directory
    - Rename the csv as APD_crime.csv
    - Save `getdata_APD_crime.R` to your working directory
    - Run the following in the R command line:
        - `source('./getdata_APD_crime.R')`
        - `getdata()`
- This will output 2 files in the working directory:
    - COBRA_cleaned.csv: non-error rows, with extra columns X, X.1, X.2 removed
    - COBRA_errors.csv: error rows only
    
The following packages must be loaded:

```{r}
library(readxl)
library(tidyr)
library(dplyr)
library(leaflet)
library(Hmisc)
library(lubridate)
```
    
## Get Data

First we'll download the zip file. Commented lines were run once.

```{r}
# temp <- tempfile(tmpdir = "/Users/robertgordon/Documents/apdCrimeData/apdFirstProj/apdCrime1/")
# download.file(url = "http://www.atlantapd.org/files/crimedata/COBRA110416.zip"
              # ,destfile =  "/Users/robertgordon/Documents/apdCrimeData/apdFirstProj/apdCrime1/COBRA110416.zip")
apdCrimeData <- read_excel("/Users/robertgordon/Documents/apdCrimeData/apdFirstProj/apdCrime1/COBRA110416.xlsx"
  , sheet="Query")
# unlink(temp)
```

Let's check and make sure each column is what we expect it to be:

```{r}
apdCrimeData %>% str()
names(apdCrimeData) <- gsub(" ", "_", names(apdCrimeData))
apdCrimeDataTidy <- apdCrimeData %>% 
  mutate(MI_PRINX = as.numeric(MI_PRINX),
         offense_id = as.numeric(offense_id),
         rpt_date = lubridate::as_date(rpt_date, format = "%m/%d/%Y"),
         occur_date = lubridate::as_date(occur_date, format = "%m/%d/%Y"),
         poss_date = lubridate::as_date(poss_date, format = "%m/%d/%Y"),
         x = as.numeric(x),
         y = as.numeric(y))
```

Let's use pieces from `codeforatlanta`'s function to tidy this data:

```{r}
errors_horiz_offset <- c(91350923, 91420511, 91471067, 91521689, 101540909, 
                           101701138, 111971638, 112090917, 112411694, 113130827, 
                           113221244, 113270554, 113531411, 113590628, 120230979, 
                           122561142, 130101490, 141621526, 142570818, 151362710)
errors_strange_date <- c(141260924)
errors_all <- c(errors_horiz_offset, errors_strange_date)
apdCrimeDataClean <- apdCrimeDataTidy %>% 
  filter(!(offense_id %in% errors_all)) 
apdCrimeDataErrors <- apdCrimeDataTidy %>% 
  filter(offense_id %in% errors_all) 
```

Now let's plot 100 crimes on a map in leaflet.

```{r}
describe(apdCrimeDataClean %>% select(x, y))
apdCrimeDataClean %>% 
  slice(1:100) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(lng = ~x, lat = ~y, popup = ~UC2_Literal)
```


## Session Info

```{r}
sessionInfo()
```
